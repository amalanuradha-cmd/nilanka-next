<?php

namespace App\Http\Controllers;

use App\Http\Requests\CreateOrderRequest;
use App\Http\Requests\UpdateOrderRequest;
use App\Repositories\OrderRepository;
use App\Http\Controllers\AppBaseController;
use Illuminate\Http\Request;
use Flash;
use Response;
use App\Models\Order;
use App\Models\OrderAddress;
use Milon\Barcode\Facades\DNS1DFacade as DNS1D;

class OrderController extends AppBaseController
{
    /** @var  OrderRepository */
    private $orderRepository;

    public function __construct(OrderRepository $orderRepo)
    {
        $this->orderRepository = $orderRepo;
    }

    /**
     * Display a listing of the Order.
     *
     * @param Request $request
     *
     * @return Response
     */
    public function index(Request $request)
    {
        $orders = $this->orderRepository->all();

        return $orders;
    }

    /**
     * Show the form for creating a new Order.
     *
     * @return Response
     */
    public function create()
    {
        return view('orders.create');
    }

    /**
     * Store a newly created Order in storage.
     *
     * @param CreateOrderRequest $request
     *
     * @return Response
     */
    public function store(Request $request)
    {
        
        $user_id = $request->user()->id;
        $request->request->add(['user_id' => $user_id]); 
        $input = $request->all();
        
        // return $input;
      
        $order = Order::create($input);
        
        // return (string) $order->id;
        
    //  $barcode = DNS1D::getBarcodeSVG($order->uuid,'PHARMA2T');
    //     $order->barcode = $barcode;
    //     $order->save();

        
        $orderAddress = new OrderAddress;
        $orderAddress->street = $request->addressData['street'];
        $orderAddress->city = $request->addressData['city'];
        $orderAddress->postal_code = $request->addressData['postal_code'];
        $orderAddress->date = $request->addressData['date'];
        $orderAddress->time = $request->addressData['time'];
        $orderAddress->order_uuid = $order->uuid;
        $orderAddress->save();
        return Order::with(['user', 'order_address'])->findOrFail($order->uuid);
        
    }

    /**
     * Display the specified Order.
     *
     * @param int $id
     *
     * @return Response
     */
    public function show($id)
    {
        
        return Order::with(['user', 'order_address', 'order_items'])->findOrFail($id);
    }

    /**
     * Show the form for editing the specified Order.
     *
     * @param int $id
     *
     * @return Response
     */
    public function edit($id)
    {
        $order = $this->orderRepository->find($id);

        if (empty($order)) {
            Flash::error('Order not found');

            return redirect(route('orders.index'));
        }

        return view('orders.edit')->with('order', $order);
    }

    /**
     * Update the specified Order in storage.
     *
     * @param int $id
     * @param UpdateOrderRequest $request
     *
     * @return Response
     */
    public function update($id, UpdateOrderRequest $request)
    {
        $order = $this->orderRepository->find($id);

        if (empty($order)) {
            Flash::error('Order not found');

            return redirect(route('orders.index'));
        }

        $order = $this->orderRepository->update($request->all(), $id);

        Flash::success('Order updated successfully.');

        return redirect(route('orders.index'));
    }

    /**
     * Remove the specified Order from storage.
     *
     * @param int $id
     *
     * @throws \Exception
     *
     * @return Response
     */
    public function destroy($id)
    {
        $order = $this->orderRepository->find($id);

        if (empty($order)) {
            Flash::error('Order not found');

            return redirect(route('orders.index'));
        }

        $this->orderRepository->delete($id);

        Flash::success('Order deleted successfully.');

        return redirect(route('orders.index'));
    }

    public function myOrders(Request $request){
        $user = $request->user();
        $orders = Order::where('user_id', '=', $user->id)->get();
        return $orders;
    }
    
}
